<dom-module id="search-results-page">
  <link rel="import" href="../../bower_components/polymer/polymer.html">
  <link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
  <link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
  <link rel="import" href="../../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
  <link rel="import" href="../../bower_components/iron-list/iron-list.html">
  <link rel="import" href="../../bower_components/geo-location/geo-location.html">
  <link rel="import" href="../../bower_components/google-map/google-map.html">
  <link rel="import" href="../../bower_components/google-map/google-map-search.html">
  <link rel="import" href="../../bower_components/google-map/google-map-marker.html">

  <link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
  <link rel="import" href="./components/carecard-rx-search-input.html">
  <link rel="import" type="css" href="../css/search.css">
  <template>
    <!--<paper-dialog id="searchResults" on-iron-overlay-opened="openDialog" with-backdrop=true>
      <div id="close-dialog" onclick="searchResults.close()">
        <svg viewBox="0 0 100 100" class="octicon octicon-x"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/src/sections/graphics/sprite.octicons.svg#x" class="style-scope catalog-element"></use> </svg>
      </div>-->
      <!--<div class="title">
        <h2><span class='accent'>care</span>card</h2>
      </div>-->
<geo-location latitude="{{lat}}" idle=true longitude="{{lng}}" on-geo-response="fetchPricing" on-geo-error="handleGeolocationError" timeout="30000" maximum-age="120000"></geo-location>
<section id="searchResults">
  <google-map map="{{map}}" latitude="[[lat]]" longitude="[[lng]]" api-key="AIzaSyCdH_BQxHpwDJV_ySsUxq0iQ6JWCQlDYI8" disable-default-ui zoom=14 single-info-window=true>
    <google-map-marker map="[[map]]" latitude="[[lat]]" longitude="[[lng]]"></google-map-marker>
    <template is="dom-repeat" items="[[pharmacies]]">
      <google-map-marker class="search-marker" id="marker_[[item.NABP]]" latitude="[[item.Latitude]]" longitude="[[item.Longitude]]" title="[[item.PharmacyName]]">
      </google-map-marker>
    </template>
  </google-map>
  <div class="contents no-padding">
    <div class="detail-panel">
      <carecard-rx-search-input></carecard-rx-search-input>
      <div class="status-bar">
        <label>Showing results for:</label>
        <div id="medicationName">{{medName}}</div>
      </div>
      <paper-progress indeterminate hidden$="[[!isSearching]]"></paper-progress>
      <div class="search-result-list" hidden$="[[isSearching]]">
        <ul class="results-header">
          <li>Pharmacy</li>
          <li class="savings">Savings</li>
        </ul>
        <iron-list id="itemsList" items="[[pharmacies]]" selection-enabled=true on-selected-item-changed="centerMarker">
          <template>
              <div style="height: 70px;" class$="[[_computedClass(selected)]]">
                <ul>
                  <li>
                    <h3>[[item.PharmacyName]]</h3>
                    <span>([[item.Distance]] Miles Away)</span>
                  </li>
                  <li class="accent">
                    <h3>$[[item.Cost]]</h3>
                    <span>With CareCard</span>
                  </li>
                </ul>
              </div>
            </template>
        </iron-list>
      </div>
    </div>
  </div>
  <paper-toast id="geoError" text="There was an error fetching your location" vertical-align="auto"></paper-toast>
  <section>
    </template>

    <script>
      Polymer({

        is: 'search-results-page',
        properties: {
          medName: {
            type: String,
            value: null
          },
          isSearching: {
            type: Boolean,
            value: true
          },
          results: {
            type: Object,
            value: []
          },
          pharmacies: {
            type: Object,
            value: [],
            notify: true
          },
          map: {
            type: Object
          }
        },
        observers: [
          '_searchTermChanged(medName)'
        ],

        attached: function() {
          let map = document.querySelector("#searchResults google-map");
          let locator = document.querySelector("#searchResults geo-location") || null;
          let rxSearch = this.querySelector("carecard-rx-search-input") || null
          let mapComponent = this;
          if (map) {
            map.addEventListener("google-map-ready", (e) => {
              console.log("google map is ready.");
            })
          }

          if (rxSearch) {
            rxSearch.addEventListener("on-drug-selected", (e) => this.updateDrug(e));
          }
        },

        _searchTermChanged: function(medName) {
          if (!medName) {
            return;
          }
          this.updateDrug();
          window.sessionStorage.setItem("medName", medName);
        },

        openDialog: function() {
          window.sessionStorage.removeItem("userLocation");
          this.updateDrug();
        },

        createInfoWindow(item, map, marker) {
          let content = `
          <link rel='stylesheet' href='/src/css/marker.css'/>
          <div class="carecard-marker">
            <h2><span class="accent">$${item.Cost}</span></h2>
            <h4>${item.PharmacyName}</h4>
            <h5>${item.Address1}</h5>
            <h5>${item.City}, ${item.State}, ${item.ZipCode}</h5>
          </div>
          `;
          let infoWindow = new google.maps.InfoWindow({
            content
          });
          if (this.info) {
            this.info.close();
          }
          this.info = infoWindow;
          this.info.open(map, marker.marker);
        },

        requestLocation: function() {
          let locator = document.querySelector("geo-location") || null;
          if (locator) {
            locator.set("idle", false);
            let p = locator.fetch();
          }
        },
        handleGeolocationError: function(error) {
          console.error(error);
          this.$.geoError.open();
        },

        updateDrug: function(event) {
          this.set("isSearching", true);
          if (event) {
            let {
              detail: {
                option: drug
              }
            } = event;
            this.set("medName", drug.DrugName);
          }
          if (this.info) {
            this.info.close();
          }
          let cached = window.sessionStorage.getItem("userLocation") || undefined;
          if (cached) {
            let {
              longitude,
              latitude
            } = JSON.parse(cached);
            let map = document.querySelector("google-map");
            map.latitude = latitude;
            map.longitude = longitude;
            map.clear();
            this.fetchPricing({
              detail: {
                longitude,
                latitude
              }
            });
          } else {
            this.requestLocation();
          }
        },

        centerMarker: function(ev) {
          let list = ev.target;
          let {
            selectedItem: selected
          } = list;
          if (!selected) {
            return;
          }

          let map = document.querySelector("google-map");
          let marker = document.querySelector(`#marker_${selected.NABP}`);
          let {
            Latitude,
            Longitude
          } = selected;
          map.latitude = Latitude;
          map.longitude = Longitude;
          this.createInfoWindow(selected, map, marker);
        },

        geocodeZip: function() {
          var geocoder = new google.maps.Geocoder();
          let zipInput = document.querySelector("#splash input.zipcode") || null;
          let zipCode = zipInput ? zipInput.value : "10012";
          let map = document.querySelector("#searchResults google-map").map;
          let searchComponent = document.querySelector("#searchResults google-map-search");
          let {
            latitude: searchLatitude,
            longitude: searchLongitude
          } = searchComponent;

          geocoder.geocode({
              address: zipCode
            },
            function(results, status) {
              if (status == 'OK') {
                let {
                  latitude,
                  longitude
                } = results[0].geometry.location;
                map.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                  map: map,
                  position: results[0].geometry.location
                });
                searchLatitude = latitude;
                searchLongitude = longitude;
                searchComponent.search("pharmacies");
              } else {
                alert('Geocode was not successful for the following reason: ' + status);
              }
            }
          );
        },
        fetchPricing: function({
          detail
        }) {
          let component = this;
          let {
            latitude,
            longitude
          } = detail;
          let drug = JSON.parse(window.sessionStorage.getItem("med") || {});

          // cache location for next query
          window.sessionStorage.setItem("userLocation", JSON.stringify({
            longitude,
            latitude
          }));
          this.set("loadProgress", 70);
          if (drug) {
            let {
              PackageSize: qty,
              NDC,
              Days: days
            } = drug;
            let params = new URLSearchParams();
            params.append("qty", qty)
            params.append("NDC", NDC)
            params.append("days", "30");
            params.append("lng", longitude)
            params.append("lat", latitude);
            let query = params.toString();
            fetch(`/api/v1/pricing?${query}`).then(r => r.json()).then(res => this.updatePharmacies(res)).catch(console.error)
          }
        },

        updatePharmacies: function(response) {
          let component = this;
          let newResults = response.map(r => {
            let {
              DrugCost: {
                DrugCost: Costs
              }
            } = r;
            let Cost = Costs ? Costs.pop().Copay : false;
            let Distance = Number(r.Pharmacy.Distance).toFixed(2);
            if (!Cost) {
              return;
            }

            return Object.assign(r.Pharmacy, {
              Cost,
              Distance
            });
          });
          component.splice("pharmacies", 0, this.pharmacies.length, ...newResults);
          this.set("isSearching", false);
        },

        _computedClass: function(isSelected) {
          var classes = 'search-result-list-item';
          if (isSelected) {
            classes += ' selected';
          }
          return classes;
        },
        _unselect: function(e) {
          this.$.itemsList.deselectItem(e.model.item);
        }

      });
    </script>
</dom-module>