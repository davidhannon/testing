<dom-module id="search-results">
  <link rel="import" href="../../bower_components/polymer/polymer.html">
  <link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
  <link rel="import" href="../../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
  <link rel="import" href="../../bower_components/iron-list/iron-list.html">
  <link rel="import" href="../../bower_components/geo-location/geo-location.html">
  <link rel="import" href="../../bower_components/google-map/google-map.html">
  <link rel="import" href="../../bower_components/google-map/google-map-search.html">
  <link rel="import" href="../../bower_components/google-map/google-map-marker.html">

  <link rel="import" href="../sections/components/carecard-rx-search-input.html">

  <template>
    <style>
      :host {
        font-family: "Montserrat";
        --app-primary-color: #ee5c56;
        --app-secondary-color: #525262;
        --section-bg-grey: #f1f1f1;
      }
      
      paper-dialog {
        width: 100%;
        max-width: 80vw;
        font-family: "Montserrat";
      }

      paper-dialog .contents {
        display: flex;
      }

      .title h2 {
        font-size: 2.5em;
        font-weight: 800;
        text-align: center;
      }

      span.accent {
        color: var(--app-primary-color);
      }

      carecard-rx-search-input {
        --input-background-color: var(--section-bg-grey);
      }

      carecard-rx-search-input paper-autocomplete {
        --paper-input-container-input: {
          background-color: var(--section-bg-grey);
          padding: 10px 20px;
          --secondary-text-color: var(--app-secondary-color);
        }
        
        --paper-input-container-color: {
          color: var(--app-secondary-color);
        }

        --secondary-text-color: var(--app-secondary-color);
        
        --paper-input-container-underline: {
            display: none
          }
        --paper-input-container-underline-focus: {
            display: none
          }
        --paper-input-container-underline-disabled: {
            display: none
          }
      }
      
      .results-header {
        align-items: center;
        list-style: none;
        display: flex;
        padding: 0px;
        margin-bottom: 0px;
      }

      .results-header li {
        flex: 1 1 auto;
        font-size: 1.5em;
        font-weight: 600;
        line-height: 2;
      }
      
      .results-header li.savings {
        text-align: right;
        padding-right: 20px;
      }
      
      .search-result-list {
        flex: 0 1 35%;
        padding: 0 20px;
        max-height: 600px;
      }

      iron-list {
        max-height: calc(70px * 5);
      }

      .search-result-list label {
        color: #a8a8b0;
      }
      .search-result-list-item.selected {
        background-color: #ededed;
      }
      .search-result-list-item ul {
        align-items: center;
        border-top: 1px solid var(--section-bg-grey);
        display: flex;
        height: 100%;
        list-style: none;
        margin: 0px;
        padding: 0;
        width: 100%;
      }

      .search-result-list-item li {
        flex: 1 1 70%;
      }

      .search-result-list-item li.accent { 
        color: var(--app-primary-color);
        flex: 0 1 auto;
        margin-left: auto;
      }
      
      .search-result-list-item h3 {
        margin: 0px;
        padding: 0px;
        font-size: 16px;
        text-transform: capitalize;
      }

      .status-bar {
        margin: 20px 0px;
      }

      google-map {
        flex: 1 1 65%;
        height: 600px;
      }

      #close-dialog {
        width:40px;
        height:40px;
        position:absolute;
        left:-16px;
        top:-16px;
        background:white;
        border:1px solid #ededed;
        border-radius:50%;
        padding:0;
        margin:0;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        box-shadow:0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      #close-dialog svg {
        height:20px;
        width:20px;
        color:hsl(0, 0%, 40%);
      }

      @media(max-width: 768px) {
        #searchResults .contents {
          flex-direction: column-reverse;
        }
        google-map {
          height: 40vh;
          max-height: 600px;
        }
      }
    </style>
    <paper-dialog id="searchResults" on-iron-overlay-opened="openDialog" with-backdrop=true>
      <div id="close-dialog" onclick="searchResults.close()">
        <svg viewBox="0 0 100 100" class="octicon octicon-x"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/src/sections/graphics/sprite.octicons.svg#x" class="style-scope catalog-element"></use> </svg>
      </div>
      <div class="title">
        <h2><span class='accent'>care</span>card</h2>
      </div>
      <div class="contents">
        <div class="search-result-list">
          <carecard-rx-search-input></carecard-rx-search-input>
          <div class="status-bar">
            <label>Showing results for:</label>
            <div id="medicationName">{{medName}}</div>
          </div>
          <ul class="results-header">
            <li>Pharmacy</li>
            <li class="savings">Savings</li>
          </ul>
          <iron-list id="itemsList" items="[[pharmacies]]" selection-enabled=true on-selected-item-changed="centerMarker">
            <template>
              <div style="height: 70px;" id="[[item.NABP]]" class$="[[_computedClass(selected)]]">
                <ul>
                  <li>
                    <h3>[[item.PharmacyName]]</h3>
                    <span>([[item.Distance]] Miles Away)</span>
                  </li>
                  <li class="accent">
                    <h3>$14.04</h3>
                    <span>With CareCard</span>
                  </li>
                </ul>
              </div>
            </template>
  </iron-list>
  </div>
  <paper-toast id="geoError" text="There was an error fetching your location" vertical-align="auto"></paper-toast>
  <geo-location latitude="{{lat}}" idle=true longitude="{{lng}}" on-geo-response="fetchPharmacies" on-geo-error="handleGeolocationError" timeout="30000"></geo-location>
  <google-map latitude="[[lat]]" longitude="[[lng]]" api-key="AIzaSyCdH_BQxHpwDJV_ySsUxq0iQ6JWCQlDYI8" disable-default-ui zoom=14>
    <google-map-marker latitude="[[lat]]" longitude="[[lng]]"></google-map-marker>
    <template is="dom-repeat" items="[[pharmacies]]">
      <google-map-marker id="[[item.NABP]]Marker" latitude="[[item.Latitude]]" longitude="[[item.Longitude]]" title="[[item.PharmacyName]]">
        <h3>[[item.PharmacyName]]</h3>
      </google-map-marker>
    </template>
  </google-map>
  </div>
  <paper-dialog-scrollable>

  </paper-dialog-scrollable>
  </paper-dialog>
  </template>

  <script>
    Polymer({

      is: 'search-results',
      properties: {
        medName: {
          type: String,
          value: function() {
            return window.sessionStorage.getItem("medName") || "Lipitor";
          }
        },
        results: {
          type: Object,
          value: []
        },
        pharmacies: {
          type: Object,
          value: []
        },
        mapSearch: {
          type: Object,
          value: []
        }
      },
      observers: [

      ],

      attached: function() {
        console.log("search results loaded");
        let map = document.querySelector("search-results google-map");
        let locator = document.querySelector("search-results geo-location") || null;
        let mapComponent = this;
        if (map) {
          map.addEventListener("google-map-ready", (e) => {
            console.log("google map is ready.");
          })
        }
      },

      _equal: function(value1, value2) {
        return value1 === value2;
      },

      openDialog: function() {
        this.$.searchResults.open();
        this.updateDrug();
        this.requestLocation();
      },

      requestLocation: function() {
        let locator = document.querySelector("search-results geo-location") || null;
        if (locator) {
          locator.set("idle", false);
          let p = locator.fetch();
        }
      },
      handleGeolocationError: function(error) {
        console.error(error);
        this.$.geoError.open();
      },

      updateDrug: function() {
        this.set("medName", window.sessionStorage.getItem("medName"));
      },

      centerMarker: function(ev) {
        let list = ev.target;
        var selectedItem;
        if (!list.selectedItem) {
          return;
        }
        let resultsDialog = document.querySelector("search-results");
        let selected = resultsDialog.pharmacies.filter(p => p.selected);
        console.log(selected, list.selectedItem);
      },

      geocodeZip: function() {
        var geocoder = new google.maps.Geocoder();
        let zipInput = document.querySelector("#splash input.zipcode") || null;
        let zipCode = zipInput ? zipInput.value : "10012";
        let map = document.querySelector("search-results google-map").map;
        let searchComponent = document.querySelector("search-results google-map-search");
        let {
          latitude: searchLatitude,
          longitude: searchLongitude
        } = searchComponent;

        geocoder.geocode({
            address: zipCode
          },
          function(results, status) {
            if (status == 'OK') {
              let {
                latitude,
                longitude
              } = results[0].geometry.location;
              map.setCenter(results[0].geometry.location);
              var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location
              });
              searchLatitude = latitude;
              searchLongitude = longitude;
              searchComponent.search("pharmacies");
            } else {
              alert('Geocode was not successful for the following reason: ' + status);
            }
          }
        );
      },
      updateSearchResults: function(event, results) {
        this.results = results;
      },

      fetchPharmacies: function({
        detail
      }) {
        let {
          latitude,
          longitude
        } = detail;
        let component = this;
        fetch(`/api/v1/pharmacies?lat=${latitude}&lng=${longitude}`).then(r => r.json()).then(res => this.updatePharmacies(res)).catch(console.error)
      },

      updatePharmacies: function(response) {
        let component = this;
        response.forEach(r => component.push("pharmacies", r));
      },
      _computedClass: function(isSelected) {
        var classes = 'search-result-list-item';
        if (isSelected) {
          classes += ' selected';
        }
        return classes;
      },
      _unselect: function(e) {
        this.$.itemsList.deselectItem(e.model.item);
      }

    });
  </script>
</dom-module>